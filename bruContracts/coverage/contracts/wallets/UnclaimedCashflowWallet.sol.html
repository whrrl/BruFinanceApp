<!doctype html>
<html lang="en">
<head>
    <title>Code coverage report for contracts/wallets/UnclaimedCashflowWallet.sol</title>
    <meta charset="utf-8" />
    <link rel="stylesheet" href="../../prettify.css" />
    <link rel="stylesheet" href="../../base.css" />
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <style type='text/css'>
        .coverage-summary .sorter {
            background-image: url(../../sort-arrow-sprite.png);
        }
    </style>
</head>
<body>
<div class='wrapper'>
  <div class='pad1'>
    <h1>
      <a href="../../index.html">all files</a> / <a href="index.html">contracts/wallets/</a> UnclaimedCashflowWallet.sol
    </h1>
    <div class='clearfix'>
      <div class='fl pad1y space-right2'>
        <span class="strong">35.29% </span>
        <span class="quiet">Statements</span>
        <span class='fraction'>12/34</span>
      </div>
      <div class='fl pad1y space-right2'>
        <span class="strong">43.75% </span>
        <span class="quiet">Branches</span>
        <span class='fraction'>7/16</span>
      </div>
      <div class='fl pad1y space-right2'>
        <span class="strong">71.43% </span>
        <span class="quiet">Functions</span>
        <span class='fraction'>5/7</span>
      </div>
      <div class='fl pad1y space-right2'>
        <span class="strong">37.14% </span>
        <span class="quiet">Lines</span>
        <span class='fraction'>13/35</span>
      </div>
    </div>
  </div>
  <div class='status-line low'></div>
<pre><table class="coverage">
<tr><td class="line-count quiet">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
97
98
99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
125
126
127
128
129
130
131
132
133
134
135
136
137
138
139
140
141
142
143
144
145
146
147
148
149</td><td class="line-coverage quiet"><span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">3×</span>
<span class="cline-any cline-yes">3×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">56×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">28×</span>
<span class="cline-any cline-yes">28×</span>
<span class="cline-any cline-yes">28×</span>
<span class="cline-any cline-yes">28×</span>
<span class="cline-any cline-yes">28×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">2×</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">2×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span></td><td class="text"><pre class="prettyprint lang-js">//SPDX-License-Identifier: UNLICENSED
pragma solidity 0.8.7;
&nbsp;
import "@openzeppelin/contracts/proxy/utils/UUPSUpgradeable.sol";
import "@openzeppelin/contracts/proxy/utils/Initializable.sol";
import "@openzeppelin/contracts/token/ERC20/IERC20.sol";
import "@openzeppelin/contracts/token/ERC20/utils/SafeERC20.sol";
&nbsp;
import "./NIIMargin.sol";
&nbsp;
/**
 * @title Reserve Wallet contract
 * @author Bru-finance team
 * @notice Stores some amount as some users might not have claimed their cashflow distribution
 */
contract UnClaimedCashFlowWallet is Initializable, UUPSUpgradeable {
    using SafeERC20 for IERC20;
    uint256 public maxUnclaimedPeriod = 28; // max unclaimed dividend allowed to be claimed
    address public adminAddress; // The address of Multisig wallet
    address internal NIIWalletAddress; // The address of NII margin contract
    address internal bruTokenAddress; // The address of Bru token
    address internal tokenAddressForCashFlow; // The token address which is supported by pool
    /**
     * @notice This mapping contains last timestamp of a user claim
     */
    mapping(address =&gt; uint256) internal lastClaimedTimestamp;
    /**
     * @notice Emitted when user claims previous dividend
     * @param _amount amount claimed
     * @param _ownerAddress  address of the owner
     */
    event ClaimedPreviousDividend(uint256 _amount, address _ownerAddress);
    /**
     * @notice Emitted when the value of maxUnclaimedPeriod is changed
     * @param _maxUnClaimed  max allowed claims from past
     */
    event UnclaimedDividendMaxChanged(uint256 _maxUnClaimed);
&nbsp;
    /**
     * @dev Only admin can call functions marked by this modifier
     */
    modifier onlyAdmin() {
        <span class="missing-if-branch" title="else path not taken" >E</span>require(msg.sender == adminAddress, "Can be used only by adminAddress");
        _;
    }
&nbsp;
    /**
     * @notice Initializes the necessary varaibles for the contract
     * @param _adminAddress The address of the admin
     * @param _NIIWalletAddress The address the NIIWallet contract
     * @param _bruTokenAddress The address of the bruToken
     * @param _tokenAddressForCashFlow The address of cashflow token contract
     */
    function initialize(
        address _adminAddress,
        address _NIIWalletAddress,
        address _bruTokenAddress,
        address _tokenAddressForCashFlow
    ) external initializer {
        require(
            _adminAddress != address(0) &amp;&amp;
                _NIIWalletAddress != address(0) &amp;&amp;
                _bruTokenAddress != address(0) &amp;&amp;
                _tokenAddressForCashFlow != address(0),
            "Invalid Address"
        );
&nbsp;
        adminAddress = _adminAddress;
        NIIWalletAddress = _NIIWalletAddress;
        bruTokenAddress = _bruTokenAddress;
        tokenAddressForCashFlow = _tokenAddressForCashFlow;
        maxUnclaimedPeriod = 28;
    }
&nbsp;
    /**
     * @notice for users who have not claimed their dividend in the given time period
     */
<span class="fstat-no" title="function not covered" >    function claimUnClaimedDividend() external {</span>
<span class="cstat-no" title="statement not covered" >        require(block.timestamp - lastClaimedTimestamp[msg.sender] &gt; 86400, "come back later")</span>;
<span class="cstat-no" title="statement not covered" >        uint256 claimId = NIIMargin(NIIWalletAddress).claimId();</span>
<span class="cstat-no" title="statement not covered" >        uint256 i = 0;</span>
<span class="cstat-no" title="statement not covered" >        uint256 tempSum = 0;</span>
<span class="cstat-no" title="statement not covered" >        if (claimId &gt; maxUnclaimedPeriod) {</span>
<span class="cstat-no" title="statement not covered" >            i = claimId - maxUnclaimedPeriod</span>;
        }
<span class="cstat-no" title="statement not covered" >        for (i; i &lt; claimId; i++) {</span>
<span class="cstat-no" title="statement not covered" >            CashFlowDetails memory tempcashflow = NIIMargin(NIIWalletAddress).getCashFlowDetailsOfClaimId(i);</span>
<span class="cstat-no" title="statement not covered" >            bool claimed = NIIMargin(NIIWalletAddress).cashFlowClaimMapping(msg.sender, i);</span>
<span class="cstat-no" title="statement not covered" >            if (!claimed) {</span>
<span class="cstat-no" title="statement not covered" >                uint256 balance = Token(bruTokenAddress).balanceOfAtDate(msg.sender, tempcashflow.starttime);</span>
<span class="cstat-no" title="statement not covered" >                uint256 amountTotransfer = (balance * (tempcashflow.totalAmountToDistribute)) /</span>
                    (Token(bruTokenAddress).totalSupplyOfAtDate(tempcashflow.starttime));
<span class="cstat-no" title="statement not covered" >                require(tempcashflow.amountLeft &gt; amountTotransfer)</span>;
<span class="cstat-no" title="statement not covered" >                tempSum += amountTotransfer</span>;
<span class="cstat-no" title="statement not covered" >                tempcashflow.amountLeft -= amountTotransfer</span>;
<span class="cstat-no" title="statement not covered" >                NIIMargin(NIIWalletAddress).setCashFlowDetailsOfClaimId(tempcashflow, i)</span>;
<span class="cstat-no" title="statement not covered" >                NIIMargin(NIIWalletAddress).setCashFlowClaimedMapping(i, msg.sender, true)</span>;
            }
        }
&nbsp;
<span class="cstat-no" title="statement not covered" >        lastClaimedTimestamp[msg.sender] = block.timestamp</span>;
<span class="cstat-no" title="statement not covered" >        IERC20(tokenAddressForCashFlow).safeTransfer(msg.sender, tempSum)</span>;
<span class="cstat-no" title="statement not covered" >        emit ClaimedPreviousDividend(tempSum, msg.sender);</span>
    }
&nbsp;
    /**
     * @notice Used to get wallet's available balance
     * @param _tokenAddress The address of the token
     * @return Returns caller balance
     */
<span class="fstat-no" title="function not covered" >    function getBalance(address _tokenAddress) external view returns (uint256) {</span>
<span class="cstat-no" title="statement not covered" >        IERC20 tokenContract = IERC20(_tokenAddress);</span>
<span class="cstat-no" title="statement not covered" >        return tokenContract.balanceOf(msg.sender);</span>
    }
&nbsp;
    /**
     * @notice Transfer funds from this wallet to NII wallet.
     * @dev Only called by NIIWallet address or admin
     * @param _receiverAddress The address of token receiver
     * @param _amount The amount of token to be transferred
     * @param _tokenAddress The address of the token
     */
    function transferTo(
        address _receiverAddress,
        uint256 _amount,
        address _tokenAddress
    ) external onlyAdmin {
        require(IERC20(_tokenAddress).balanceOf(address(this)) &gt;= _amount, "reserve does not have enough liquidity");
        IERC20(_tokenAddress).safeTransfer(_receiverAddress, _amount);
    }
&nbsp;
    /**
     * @notice changes the max allowed unclaimed dividend periods for claiming past dividends
     * @param _newMaxAllowedUnclaimed  new value for  max allowed unclaimed dividend periods
     */
    function changeMaxAllowedUnClaimed(uint256 _newMaxAllowedUnclaimed) external virtual onlyAdmin {
        maxUnclaimedPeriod = _newMaxAllowedUnclaimed;
        emit UnclaimedDividendMaxChanged(_newMaxAllowedUnclaimed);
    }
&nbsp;
    /**
     * @dev Checks if the wallet initiating the upgrade transaction for a pool is the admin or not
     * @param _newImplementation Address of the new implementation contract for upgradation.
     */
    function _authorizeUpgrade(address _newImplementation) internal view override {
        require(msg.sender == adminAddress, "Only admin allowed");
    }
}
&nbsp;</pre></td></tr>
</table></pre>
<div class='push'></div><!-- for sticky footer -->
</div><!-- /wrapper -->
<div class='footer quiet pad2 space-top1 center small'>
  Code coverage
  generated by <a href="http://istanbul-js.org/" target="_blank">istanbul</a> at Wed May 31 2023 10:39:20 GMT+0530 (India Standard Time)
</div>
</div>
<script src="../../prettify.js"></script>
<script>
window.onload = function () {
        if (typeof prettyPrint === 'function') {
            prettyPrint();
        }
};
</script>
<script src="../../sorter.js"></script>
</body>
</html>
